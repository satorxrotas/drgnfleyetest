<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ìÜ§ DRGNFLEYE AGENCY ìÜ§</title>
  <link rel="icon" type="image/png" href="DRGNFLEYE_fav_01.png" />
  <link rel="apple-touch-icon" href="DRGNFLEYE_fav_01.png" />

  <!-- Three.js non-module build (works in Safari without a server) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>

  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: #ffffff;
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    }

    /* ‚îÄ‚îÄ LOADER OVERLAY ‚îÄ‚îÄ */
    #loader {
      position: fixed;
      inset: 0;
      z-index: 9999;
      display: grid;
    }

    .sq {
      background: #0a0a0a;
      border: 1px solid #ffffff;
      transform: scale(1);
      transition: transform 0.55s cubic-bezier(0.76, 0, 0.24, 1),
                  opacity   0.55s cubic-bezier(0.76, 0, 0.24, 1);
    }

    .sq.hide {
      transform: scale(0);
      opacity: 0;
    }

    /* ‚îÄ‚îÄ PAGE CONTENT ‚îÄ‚îÄ */
    #page {
      opacity: 0;
      transition: opacity 0.6s ease 0.1s;
      width: 100%;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: 0;
      background: #ffffff;
      color: #0a0a0a;
      overflow: hidden;
    }

    #page.visible { opacity: 1; }

    #page h1 {
      font-size: clamp(2rem, 6vw, 5rem);
      font-weight: 700;
      letter-spacing: -0.03em;
      text-transform: uppercase;
    }

    #page p {
      margin-top: 0.4rem;
      font-size: 0.85rem;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: #666;
    }

    /* ‚îÄ‚îÄ 3D VIEWER ‚îÄ‚îÄ */
    #viewer-wrap {
      position: relative;
      width: 100%;
      height: 50vh;
      margin-bottom: 0;
      margin-top: 0;
      cursor: grab;
      align-self: stretch;
    }
    #viewer-wrap:active { cursor: grabbing; }
    #viewer-wrap canvas { display: block; }

    #glb-hint {
      font-size: 0.65rem;
      letter-spacing: 0.15em;
      color: #aaa;
      margin-bottom: 0.25rem;
      text-transform: uppercase;
    }

    #status-msg {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: #999;
      text-align: center;
      padding: 1rem;
      line-height: 1.8;
      pointer-events: none;
    }

    #logo {
      width: min(676px, 95vw);
      margin-bottom: 0.2rem;
    }
    #logo img {
      width: 100%;
      height: auto;
    }

    /* ‚îÄ‚îÄ HORIZONTAL GALLERY SLIDER ‚îÄ‚îÄ */
    #gallery-wrap {
      width: 100%;
      margin-top: auto;
      position: relative;
      padding: 0.75rem 0;
    }

    #gallery {
      width: 100%;
      padding: 0 1rem;
      display: flex;
      flex-direction: row;
      gap: 0.5rem;
      overflow-x: auto;
      overflow-y: hidden;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      scroll-behavior: smooth;
    }
    #gallery::-webkit-scrollbar { display: none; }

    .thumb {
      flex: 0 0 auto;
      width: clamp(140px, 18vw, 220px);
      height: clamp(90px, 12vw, 145px);
      overflow: hidden;
      cursor: pointer;
      position: relative;
    }

    .thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      transition: transform 0.4s ease, opacity 0.4s ease;
    }

    .thumb:hover img {
      transform: scale(1.04);
      opacity: 0.85;
    }

    /* arrows */
    .gallery-arrow {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      z-index: 10;
      width: 36px;
      height: 36px;
      background: #0a0a0a;
      border: 1px solid #333;
      color: #f0ede6;
      font-size: 0.75rem;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.25s ease, background 0.2s ease;
      pointer-events: none;
      user-select: none;
    }
    .gallery-arrow:hover { background: #222; }

    #arrow-left  { left: 0.25rem; }
    #arrow-right { right: 0.25rem; }

    /* show right arrow by default (can scroll right), left only when scrolled */
    #gallery-wrap.can-right #arrow-right { opacity: 1; pointer-events: auto; }
    #gallery-wrap.can-left  #arrow-left  { opacity: 1; pointer-events: auto; }

    /* hover-to-scroll zones ‚Äî invisible overlays on left/right edges */
    .gallery-hover-zone {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 80px;
      z-index: 5;
      cursor: none;
    }
    #hz-left  { left: 0; }
    #hz-right { right: 0; }

    /* ‚îÄ‚îÄ LIGHTBOX ‚îÄ‚îÄ */
    #lightbox {
      position: fixed;
      inset: 0;
      z-index: 8888;
      display: flex;
      flex-direction: column;
      pointer-events: none;
    }

    /* dark backdrop ‚Äî fades in */
    #lb-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0);
      transition: background 0.45s ease;
    }
    #lightbox.open #lb-backdrop {
      background: rgba(0,0,0,0.55);
      pointer-events: auto;
    }

    /* panel slides up from bottom */
    #lb-panel {
      position: absolute;
      left: 0; right: 0; bottom: 0;
      height: 100vh;
      background: #0a0a0a;
      color: #f0ede6;
      transform: translateY(100%);
      transition: transform 0.55s cubic-bezier(0.76, 0, 0.24, 1);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      pointer-events: none;
    }
    #lightbox.open #lb-panel {
      transform: translateY(0);
      pointer-events: auto;
    }

    /* top bar */
    #lb-topbar {
      flex: 0 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1.25rem 2rem;
      border-bottom: 1px solid #222;
    }
    #lb-project-tag {
      font-size: 0.7rem;
      letter-spacing: 0.25em;
      text-transform: uppercase;
      color: #555;
    }
    #lb-topbar-btns {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    #lb-next {
      background: none;
      border: 1px solid #333;
      color: #f0ede6;
      font-size: 0.7rem;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      padding: 0.4rem 1rem;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
      font-family: 'Helvetica Neue', sans-serif;
    }
    #lb-next:hover { background: #f0ede6; color: #0a0a0a; }

    #lb-close {
      background: none;
      border: 1px solid #333;
      color: #f0ede6;
      font-size: 0.7rem;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      padding: 0.4rem 1rem;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
    }
    #lb-close:hover { background: #f0ede6; color: #0a0a0a; }

    /* scrollable body inside panel */
    #lb-body {
      flex: 1 1 auto;
      overflow-y: auto;
      overflow-x: hidden;
      display: flex;
      flex-direction: column;
      gap: 0;
      scrollbar-width: thin;
      scrollbar-color: #333 transparent;
    }

    /* breadcrumb */
    #lb-breadcrumb {
      font-size: 0.7rem;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: #555;
      font-family: 'Helvetica Neue', sans-serif;
    }

    /* full-bleed images ‚Äî zero gap, edge to edge */
    .lb-full-img {
      width: 100%;
      line-height: 0;
    }
    .lb-full-img img {
      width: 100%;
      height: auto;
      display: block;
    }

    /* info block */
    #lb-info {
      padding: 2rem 2rem 2.5rem;
      background: #0a0a0a;
    }

    #lb-title {
      font-size: clamp(2rem, 5vw, 4rem);
      font-weight: 700;
      letter-spacing: -0.03em;
      text-transform: uppercase;
      color: #f0ede6;
      line-height: 1;
      margin-bottom: 0.75rem;
    }

    #lb-artist-line,
    #lb-collab-line {
      font-size: 0.78rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: #888;
      margin-bottom: 0.2rem;
    }

    .lb-label {
      color: #555;
      font-size: 0.7rem;
    }

    /* two-column text */
    #lb-two-col {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2.5rem;
      margin-top: 2rem;
    }
    @media (max-width: 650px) {
      #lb-two-col { grid-template-columns: 1fr; }
    }

    .lb-section-label {
      font-size: 0.65rem;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: #e03030;
      margin-bottom: 0.5rem;
      font-weight: 600;
    }

    .lb-body-text {
      font-size: 0.88rem;
      line-height: 1.75;
      color: #999;
    }

    /* YouTube embed */
    #lb-video-wrap {
      width: 100%;
      background: #000;
      padding: 0;
    }
    #lb-video-inner {
      position: relative;
      width: 100%;
      padding-top: 56.25%; /* 16:9 */
    }
    #lb-video-inner iframe {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      border: none;
    }

    /* ‚îÄ‚îÄ LIGHTBOX TRANSITION OVERLAY ‚îÄ‚îÄ */
    #lb-transition {
      position: absolute;
      inset: 0;
      z-index: 9000;
      display: grid;
      pointer-events: none;
      opacity: 0;
    }
    #lb-transition.active { pointer-events: auto; opacity: 1; }

    .lb-sq {
      background: #ffffff;
      border: 1px solid #0a0a0a;
      transform: scale(0);
      transition: transform 0.45s cubic-bezier(0.76, 0, 0.24, 1),
                  opacity   0.45s cubic-bezier(0.76, 0, 0.24, 1);
    }
    .lb-sq.show { transform: scale(1); opacity: 1; }
    .lb-sq.hide { transform: scale(0); opacity: 0; }

    /* counter */
    #counter {
      position: fixed;
      bottom: 2rem;
      left: 50%;
      transform: translateX(-50%);
      z-index: 99999;
      font-family: 'Helvetica Neue', monospace;
      font-size: 0.75rem;
      letter-spacing: 0.2em;
      color: #444;
      transition: opacity 0.4s;
    }
  </style>
</head>
<body>

  <div id="loader"></div>
  <div id="counter">LOADING</div>

  <div id="page">
    <div id="viewer-wrap">
      <div id="status-msg">Loading model‚Ä¶</div>
    </div>
    <p id="glb-hint">drag to rotate</p>
    <div id="logo">
      <img src="DRGNFLEYE_horizontal_01.svg" alt="DRGNFLEYE Agency" />
    </div>
    <p>CREATIVE DIRECTION ‚ú∫ DESIGN ‚ú∫ MEDIA CREATORS</p>

    <!-- ‚îÄ‚îÄ HORIZONTAL GALLERY SLIDER ‚îÄ‚îÄ -->
    <div id="gallery-wrap">
      <div class="gallery-arrow" id="arrow-left">&#8592;</div>
      <div class="gallery-arrow" id="arrow-right">&#8594;</div>
      <div class="gallery-hover-zone" id="hz-left"></div>
      <div class="gallery-hover-zone" id="hz-right"></div>
      <div id="gallery">
        <div class="thumb" data-project="0"><img src="thumbnail_01.jpg" alt="Project 01" /></div>
        <div class="thumb" data-project="1"><img src="thumbnail_02.jpg" alt="Project 02" /></div>
        <div class="thumb" data-project="0"><img src="thumbnail_01.jpg" alt="Project 03" /></div>
        <div class="thumb" data-project="1"><img src="thumbnail_02.jpg" alt="Project 04" /></div>
        <div class="thumb" data-project="0"><img src="thumbnail_01.jpg" alt="Project 05" /></div>
        <div class="thumb" data-project="1"><img src="thumbnail_02.jpg" alt="Project 06" /></div>
        <div class="thumb" data-project="0"><img src="thumbnail_01.jpg" alt="Project 07" /></div>
        <div class="thumb" data-project="1"><img src="thumbnail_02.jpg" alt="Project 08" /></div>
      </div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ LIGHTBOX ‚îÄ‚îÄ -->
  <div id="lightbox">
    <div id="lb-backdrop"></div>
    <div id="lb-panel">

      <!-- Transition overlay ‚Äî white squares on black -->
      <div id="lb-transition"></div>

      <!-- Fixed top bar -->
      <div id="lb-topbar">
        <span id="lb-breadcrumb">DRGNFLEYE AGENCY &nbsp;|&nbsp; Alissia // "Hypnotic Nights"</span>
        <div id="lb-topbar-btns">
          <button id="lb-next">NEXT &nbsp;&#8594;</button>
          <button id="lb-close">‚úï &nbsp;CLOSE</button>
        </div>
      </div>

      <!-- Scrollable body -->
      <div id="lb-body">

        <!-- 1. Hero image ‚Äî full bleed -->
        <div class="lb-full-img">
          <img src="alissia_01.jpg" alt="Hypnotic Nights Hero" />
        </div>

        <!-- 2. Title + info block -->
        <div id="lb-info">
          <h2 id="lb-title">HYPNOTIC NIGHTS</h2>
          <div id="lb-artist-line">
            <span class="lb-label">Artist:</span> ALISSIA
          </div>
          <div id="lb-collab-line">
            <span class="lb-label">Collaborators:</span> AMAZON MUSIC, ALISSIA, NILE RODGERS, EARTHGANG
          </div>

          <!-- Two-column text -->
          <div id="lb-two-col">
            <div class="lb-col">
              <p class="lb-section-label">DESCRIPTION:</p>
              <p class="lb-body-text">A short doc for Amazon Music, showcasing Producer of the Year Grammy nominee, Alissia's pivot from a producer to Artist with debut record "Hypnotic Nights" featuring Nile Rodgers and EARTHGANG.</p>

              <p class="lb-section-label" style="margin-top:1.5rem">EXECUTION:</p>
              <p class="lb-body-text">Role: Creative Director, Editor, Designer</p>

              <p class="lb-section-label" style="margin-top:1.5rem">PRESS:</p>
              <p class="lb-body-text">PAPER Mag</p>

              <p class="lb-section-label" style="margin-top:1.5rem">EXTENDED TEAM:</p>
              <p class="lb-body-text">Park Avenue Artists<br>Amazon Music</p>
            </div>
            <div class="lb-col">
              <p class="lb-section-label">STRATEGY:</p>
              <p class="lb-body-text">The "Hypnotic Nights" campaign established a unified visual world across the single's identity, a behind-the-scenes short doc, and a cohesive design system. The aesthetic leaned into moody contrast, deep shadows, and a signature pop of red to frame Alissia's regal, funk-driven presence. The short doc highlighted her role as a generational bridge‚Äîshowcasing Nile Rodgers and EarthGang recording together in the same studio where CHIC created its signature sound. The rollout followed her historic Producer of the Year Grammy nomination, where she became only the ninth woman ever recognized in the category. Strategically, the campaign centered on intimacy and craft, combining storytelling-led content, interactive text activations, and NYC/LA posters to introduce a clear sonic-and-visual identity for this new era.</p>
            </div>
          </div>
        </div>

        <!-- 3. YouTube embed -->
        <div id="lb-video-wrap">
          <div id="lb-video-inner">
            <iframe
              src="https://www.youtube.com/embed/DvAv4StoKd4"
              title="Alissia ‚Äî Hypnotic Nights feat. Nile Rodgers &amp; EARTHGANG"
              frameborder="0"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
              allowfullscreen>
            </iframe>
          </div>
        </div>

        <!-- 4‚Äì7. Stacked full-bleed images -->
        <div class="lb-full-img"><img src="alissia_02.jpg" alt="Alissia 02" /></div>
        <div class="lb-full-img"><img src="alissia_03.jpg" alt="Alissia 03" /></div>
        <div class="lb-full-img"><img src="alissia_04.jpg" alt="Alissia 04" /></div>
        <div class="lb-full-img"><img src="alissia_05.jpg" alt="Alissia 05" /></div>

      </div><!-- /lb-body -->
    </div><!-- /lb-panel -->
  </div><!-- /lightbox -->

  <script>
    /* ‚îÄ‚îÄ LOADER ANIMATION ‚îÄ‚îÄ */
    const loader  = document.getElementById('loader');
    const counter = document.getElementById('counter');
    const page    = document.getElementById('page');
    const SQ_SIZE = 80;

    function buildGrid() {
      const cols = Math.ceil(window.innerWidth  / SQ_SIZE);
      const rows = Math.ceil(window.innerHeight / SQ_SIZE);
      loader.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
      loader.style.gridTemplateRows    = `repeat(${rows}, 1fr)`;
      loader.innerHTML = '';
      for (let i = 0; i < cols * rows; i++) {
        const sq = document.createElement('div');
        sq.className = 'sq';
        loader.appendChild(sq);
      }
      return { cols, rows };
    }

    function dist(ax, ay, bx, by) {
      return Math.sqrt((ax - bx) ** 2 + (ay - by) ** 2);
    }

    function animateOut(cols, rows) {
      const squares = loader.querySelectorAll('.sq');
      const cx = cols / 2, cy = rows / 2;
      const indexed = Array.from(squares).map((sq, i) => ({
        sq, d: dist(i % cols, Math.floor(i / cols), cx, cy)
      }));
      const maxD = Math.max(...indexed.map(s => s.d));
      const duration = 900;
      let start = null;

      function tick(ts) {
        if (!start) start = ts;
        const pct = Math.min((ts - start) / duration, 1);
        counter.textContent = Math.round(pct * 100) + '%';
        indexed.forEach(({ sq, d }) => {
          if (pct >= (d / maxD) * 0.85 && !sq.classList.contains('hide'))
            sq.classList.add('hide');
        });
        if (pct < 1) {
          requestAnimationFrame(tick);
        } else {
          setTimeout(() => {
            loader.style.display = 'none';
            counter.style.opacity = '0';
            page.classList.add('visible');
          }, 350);
        }
      }
      requestAnimationFrame(tick);
    }

    const { cols, rows } = buildGrid();
    setTimeout(() => animateOut(cols, rows), 800);

    /* ‚îÄ‚îÄ THREE.JS GLB VIEWER WITH BAYER DITHER ‚îÄ‚îÄ */
    window.addEventListener('load', function() {
      // Wait until page is visible so dimensions are correct
      function initViewer() {
        const wrap   = document.getElementById('viewer-wrap');
        const status = document.getElementById('status-msg');

        // Force layout recalc
        const W = wrap.offsetWidth  || 420;
        const H = wrap.offsetHeight || 420;

      // ‚îÄ‚îÄ Renderer (renders scene to a texture, not directly to screen)
      const renderer = new THREE.WebGLRenderer({ antialias: false, alpha: false });
      renderer.setPixelRatio(1); // keep at 1 so dither pixels are crisp
      renderer.setSize(W, H);
      renderer.outputEncoding = THREE.sRGBEncoding;
      wrap.insertBefore(renderer.domElement, status);

      // ‚îÄ‚îÄ Scene & Camera
      const scene  = new THREE.Scene();
      scene.background = new THREE.Color(0xffffff);
      const camera = new THREE.PerspectiveCamera(45, W / H, 0.01, 1000);
      camera.position.set(0, 0, 4);

      // ‚îÄ‚îÄ Lights
      scene.add(new THREE.AmbientLight(0xffffff, 0.9));
      const dir = new THREE.DirectionalLight(0xffffff, 1.2);
      dir.position.set(5, 10, 7);
      scene.add(dir);
      const fill = new THREE.DirectionalLight(0xffffff, 0.4);
      fill.position.set(-5, -5, -5);
      scene.add(fill);

      // ‚îÄ‚îÄ Pivot group for rotation
      const pivot = new THREE.Group();
      scene.add(pivot);

      // ‚îÄ‚îÄ Drag to rotate
      let isDragging = false, prevX = 0, prevY = 0, rotX = 0, rotY = 0;
      renderer.domElement.addEventListener('mousedown', e => { isDragging = true; prevX = e.clientX; prevY = e.clientY; });
      renderer.domElement.addEventListener('touchstart', e => { isDragging = true; prevX = e.touches[0].clientX; prevY = e.touches[0].clientY; });
      window.addEventListener('mouseup',  () => isDragging = false);
      window.addEventListener('touchend', () => isDragging = false);
      window.addEventListener('mousemove', e => {
        if (!isDragging) return;
        rotY += (e.clientX - prevX) * 0.01;
        rotX += (e.clientY - prevY) * 0.01;
        prevX = e.clientX; prevY = e.clientY;
        pivot.rotation.y = rotY;
        pivot.rotation.x = rotX;
      });
      window.addEventListener('touchmove', e => {
        if (!isDragging) return;
        rotY += (e.touches[0].clientX - prevX) * 0.01;
        rotX += (e.touches[0].clientY - prevY) * 0.01;
        prevX = e.touches[0].clientX; prevY = e.touches[0].clientY;
        pivot.rotation.y = rotY;
        pivot.rotation.x = rotX;
      });
      renderer.domElement.addEventListener('wheel', e => {
        camera.position.z = Math.max(0.5, Math.min(10, camera.position.z + e.deltaY * 0.005));
      });

      // ‚îÄ‚îÄ Render Target: scene renders here first
      const renderTarget = new THREE.WebGLRenderTarget(W, H, {
        minFilter: THREE.LinearFilter,
        magFilter: THREE.LinearFilter,
        format: THREE.RGBAFormat
      });

      // ‚îÄ‚îÄ Bayer 8√ó8 Dither Post-Process Shader
      // The 8√ó8 Bayer matrix gives 65 luminance levels for smooth gradients.
      // Our twist: we keep two ink colors (dark + white bg) but add a subtle
      // blue-tinted midtone so it feels original rather than pure 1-bit.
      const ditherMaterial = new THREE.ShaderMaterial({
        uniforms: {
          tDiffuse:   { value: renderTarget.texture },
          resolution: { value: new THREE.Vector2(W, H) },
          pixelSize:  { value: 3.0 },   // size of each dither cell in screen px
          inkColor:   { value: new THREE.Color(0x0a0a0a) },
          paperColor: { value: new THREE.Color(0xffffff) },
        },
        vertexShader: `
          varying vec2 vUv;
          void main() {
            vUv = uv;
            gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
          }
        `,
        fragmentShader: `
          uniform sampler2D tDiffuse;
          uniform vec2      resolution;
          uniform float     pixelSize;
          uniform vec3      inkColor;
          uniform vec3      paperColor;
          varying vec2 vUv;

          // 8x8 Bayer threshold matrix (values 0-63, normalised to 0-1)
          float bayer8(int x, int y) {
            int m[64];
            m[0]= 0; m[1]=32; m[2]= 8; m[3]=40; m[4]= 2; m[5]=34; m[6]=10; m[7]=42;
            m[8]=48; m[9]=16; m[10]=56;m[11]=24; m[12]=50;m[13]=18; m[14]=58;m[15]=26;
            m[16]=12;m[17]=44; m[18]= 4;m[19]=36; m[20]=14;m[21]=46; m[22]= 6;m[23]=38;
            m[24]=60;m[25]=28; m[26]=52;m[27]=20; m[28]=62;m[29]=30; m[30]=54;m[31]=22;
            m[32]= 3;m[33]=35; m[34]=11;m[35]=43; m[36]= 1;m[37]=33; m[38]= 9;m[39]=41;
            m[40]=51;m[41]=19; m[42]=59;m[43]=27; m[44]=49;m[45]=17; m[46]=57;m[47]=25;
            m[48]=15;m[49]=47; m[50]= 7;m[51]=39; m[52]=13;m[53]=45; m[54]= 5;m[55]=37;
            m[56]=63;m[57]=31; m[58]=55;m[59]=23; m[60]=61;m[61]=29; m[62]=53;m[63]=21;
            return float(m[y * 8 + x]) / 64.0;
          }

          void main() {
            // Pixelate UV to dither grid
            vec2 fragCoord = vUv * resolution;
            vec2 pixelated = floor(fragCoord / pixelSize) * pixelSize;
            vec2 sampledUV = pixelated / resolution;

            vec4 color = texture2D(tDiffuse, sampledUV);

            // Luminance (perceptual weights)
            float lum = dot(color.rgb, vec3(0.299, 0.587, 0.114));

            // Bayer matrix position
            int bx = int(mod(fragCoord.x / pixelSize, 8.0));
            int by = int(mod(fragCoord.y / pixelSize, 8.0));
            float threshold = bayer8(bx, by);

            // Dither decision ‚Äî original twist: soft blend near edges
            // gives a slightly softer look vs pure 1-bit
            float dithered = step(threshold, lum);

            // Mix ink and paper colors
            vec3 result = mix(inkColor, paperColor, dithered);

            // Preserve transparency: fully transparent pixels stay transparent
            gl_FragColor = vec4(result, color.a);
          }
        `
      });

      // ‚îÄ‚îÄ Full-screen quad to display the dithered result
      const quadGeo  = new THREE.PlaneGeometry(2, 2);
      const quadMesh = new THREE.Mesh(quadGeo, ditherMaterial);
      const quadScene  = new THREE.Scene();
      const quadCamera = new THREE.OrthographicCamera(-1, 1, 1, -1, 0, 1);
      quadScene.add(quadMesh);

      // ‚îÄ‚îÄ Load GLTFLoader then model
      const loaderScript = document.createElement('script');
      loaderScript.src = 'https://cdn.jsdelivr.net/npm/three@0.134.0/examples/js/loaders/GLTFLoader.js';
      loaderScript.onload = function() {
        const gltfLoader = new THREE.GLTFLoader();
        gltfLoader.load(
          'drgnfly.glb',
          function(gltf) {
            status.style.display = 'none';
            const model = gltf.scene;
            const box    = new THREE.Box3().setFromObject(model);
            const size   = box.getSize(new THREE.Vector3());
            const centre = box.getCenter(new THREE.Vector3());
            const maxDim = Math.max(size.x, size.y, size.z);
            model.scale.setScalar(2.6 / maxDim);
            model.position.sub(centre.multiplyScalar(2 / maxDim));
            pivot.add(model);
          },
          function(xhr) {
            if (xhr.total) status.textContent = 'Loading ' + Math.round(xhr.loaded / xhr.total * 100) + '%';
          },
          function(err) {
            console.error(err);
            status.style.fontSize = '0.62rem';
            status.innerHTML = '‚ö†Ô∏è Could not load drgnfly.glb<br><br>Make sure drgnfly.glb is in the<br>same folder as index.html';
          }
        );
      };
      document.head.appendChild(loaderScript);

      // ‚îÄ‚îÄ Render loop: scene ‚Üí renderTarget ‚Üí dither shader ‚Üí screen
      (function animate() {
        requestAnimationFrame(animate);
        pivot.rotation.y += 0.003;

        // 1. Render scene into texture
        renderer.setRenderTarget(renderTarget);
        renderer.render(scene, camera);

        // 2. Apply dither shader and render to screen
        renderer.setRenderTarget(null);
        renderer.render(quadScene, quadCamera);
      })();

      // ‚îÄ‚îÄ Resize
      window.addEventListener('resize', () => {
        const w = wrap.offsetWidth, h = wrap.offsetHeight;
        camera.aspect = w / h;
        camera.updateProjectionMatrix();
        renderer.setSize(w, h);
        renderTarget.setSize(w, h);
        ditherMaterial.uniforms.resolution.value.set(w, h);
      });
      } // end initViewer

      // Delay init until after loader reveals the page so dimensions are correct
      setTimeout(initViewer, 1400);
    });
    /* ‚îÄ‚îÄ GALLERY SLIDER ‚îÄ‚îÄ */
    const galleryWrap  = document.getElementById('gallery-wrap');
    const gallery      = document.getElementById('gallery');
    const arrowLeft    = document.getElementById('arrow-left');
    const arrowRight   = document.getElementById('arrow-right');
    const hzLeft       = document.getElementById('hz-left');
    const hzRight      = document.getElementById('hz-right');
    const SCROLL_STEP  = 320;
    let   hoverScroll  = null;

    function updateArrows() {
      const atStart = gallery.scrollLeft <= 2;
      const atEnd   = gallery.scrollLeft + gallery.clientWidth >= gallery.scrollWidth - 2;
      galleryWrap.classList.toggle('can-left',  !atStart);
      galleryWrap.classList.toggle('can-right', !atEnd);
    }

    // Arrow click ‚Äî scroll by step
    arrowLeft.addEventListener('click',  () => { gallery.scrollLeft -= SCROLL_STEP; });
    arrowRight.addEventListener('click', () => { gallery.scrollLeft += SCROLL_STEP; });

    // Hover zones ‚Äî continuous scroll while hovering
    function startHoverScroll(dir) {
      stopHoverScroll();
      hoverScroll = setInterval(() => { gallery.scrollLeft += dir * 4; }, 16);
    }
    function stopHoverScroll() {
      clearInterval(hoverScroll);
      hoverScroll = null;
    }

    hzRight.addEventListener('mouseenter', () => startHoverScroll(1));
    hzRight.addEventListener('mouseleave', stopHoverScroll);
    hzLeft.addEventListener('mouseenter',  () => startHoverScroll(-1));
    hzLeft.addEventListener('mouseleave',  stopHoverScroll);

    gallery.addEventListener('scroll', updateArrows);
    updateArrows(); // initial state

    /* ‚îÄ‚îÄ LIGHTBOX LOGIC ‚îÄ‚îÄ */
    const lightbox    = document.getElementById('lightbox');
    const backdrop    = document.getElementById('lb-backdrop');
    const closeBtn    = document.getElementById('lb-close');
    const nextBtn     = document.getElementById('lb-next');
    const lbBody      = document.getElementById('lb-body');
    const lbTransition = document.getElementById('lb-transition');

    const thumbs = document.querySelectorAll('.thumb');
    const totalProjects = [...new Set([...thumbs].map(t => t.dataset.project))].length;
    let currentProject = 0;
    let isTransitioning = false;

    // ‚îÄ‚îÄ Build the transition grid to fill lb-panel
    function buildTransitionGrid() {
      const panel = document.getElementById('lb-panel');
      const SQ = 80;
      const cols = Math.ceil(panel.offsetWidth  / SQ);
      const rows = Math.ceil(panel.offsetHeight / SQ);
      lbTransition.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
      lbTransition.style.gridTemplateRows    = `repeat(${rows}, 1fr)`;
      lbTransition.innerHTML = '';
      for (let i = 0; i < cols * rows; i++) {
        const sq = document.createElement('div');
        sq.className = 'lb-sq';
        lbTransition.appendChild(sq);
      }
      return { cols, rows };
    }

    function lbDist(ax, ay, bx, by) {
      return Math.sqrt((ax - bx) ** 2 + (ay - by) ** 2);
    }

    // Animate squares IN (cover), call midCallback at peak, then animate OUT (reveal)
    function runTransition(midCallback) {
      if (isTransitioning) return;
      isTransitioning = true;

      const { cols, rows } = buildTransitionGrid();
      const squares = lbTransition.querySelectorAll('.lb-sq');
      const cx = cols / 2, cy = rows / 2;
      const indexed = Array.from(squares).map((sq, i) => ({
        sq, d: lbDist(i % cols, Math.floor(i / cols), cx, cy)
      }));
      const maxD = Math.max(...indexed.map(s => s.d));
      const duration = 650;

      lbTransition.classList.add('active');

      // Phase 1: squares ripple IN from centre
      let startIn = null;
      function tickIn(ts) {
        if (!startIn) startIn = ts;
        const pct = Math.min((ts - startIn) / duration, 1);
        indexed.forEach(({ sq, d }) => {
          if (pct >= (d / maxD) * 0.8 && !sq.classList.contains('show'))
            sq.classList.add('show');
        });
        if (pct < 1) {
          requestAnimationFrame(tickIn);
        } else {
          // All covered ‚Äî run the content swap
          midCallback();
          lbBody.scrollTop = 0;

          // Phase 2: squares ripple OUT from centre
          let startOut = null;
          function tickOut(ts2) {
            if (!startOut) startOut = ts2;
            const pct2 = Math.min((ts2 - startOut) / duration, 1);
            indexed.forEach(({ sq, d }) => {
              if (pct2 >= (d / maxD) * 0.8 && !sq.classList.contains('hide')) {
                sq.classList.remove('show');
                sq.classList.add('hide');
              }
            });
            if (pct2 < 1) {
              requestAnimationFrame(tickOut);
            } else {
              lbTransition.classList.remove('active');
              lbTransition.innerHTML = '';
              isTransitioning = false;
            }
          }
          requestAnimationFrame(tickOut);
        }
      }
      requestAnimationFrame(tickIn);
    }

    function openLightbox(idx) {
      currentProject = idx;
      lbBody.scrollTop = 0;
      lightbox.style.pointerEvents = 'auto';
      lightbox.classList.add('open');
    }

    function closeLightbox() {
      lightbox.classList.remove('open');
      lightbox.style.pointerEvents = 'none';
    }

    function nextProject() {
      const nextIdx = (currentProject + 1) % totalProjects;
      runTransition(() => {
        currentProject = nextIdx;
        // Future: swap project content here when multiple projects exist
      });
    }

    thumbs.forEach(el => {
      el.addEventListener('click', () => openLightbox(+el.dataset.project));
    });

    nextBtn.addEventListener('click', nextProject);
    closeBtn.addEventListener('click', closeLightbox);
    backdrop.addEventListener('click', closeLightbox);
    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') closeLightbox();
      if (e.key === 'ArrowRight' && lightbox.classList.contains('open')) nextProject();
    });
  </script>
</body>
</html>
